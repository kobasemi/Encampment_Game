<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Encampment Game by AI</title>
<style>
#BackGround {
	position: absolute; top: 0px; left: 0px; z-index: 0;
}
#Color_Field {
	position: absolute; top: 0px; left: 0px; z-index: 1;
}
#Event_Field {
	position: absolute; top: 0px; left: 0px; z-index: 2;
}
#AI_Field {
	position: absolute; top: 0px; left: 0px; z-index: 3;
}
</style>

<script>
	var createjs = window;
</script>
<script src="https://code.jquery.com/jquery-1.11.3.js"></script>
<script src="https://code.createjs.com/easeljs-0.8.1.min.js"></script>
<script src="https://code.createjs.com/tweenjs-0.6.1.min.js"></script>
<script>
	/* 背景の描画関数 */
	function drawBackGround() {
		var cnvs = document.getElementById("BackGround");
		var ctx = cnvs.getContext("2d");
		var img = new Image();
		img.src = "img/field.png";
		img.onload = function() {
			ctx.drawImage(img, 0, 0, 572, 624);
		}
	}

	/* 色々準備関数 */
	function initialize() {
		$.ajaxSetup({ async : false});
		$.getJSON("json/AI.json", function(data) { AI_Log = data; }); //json拾ってくる処理
		$.getJSON("json/Event.json", function(data) { Event_Log = data; });
		$.ajaxSetup({ async : true });

		var AICanvas = document.getElementById("AI_Field"); //AI描画キャンバスの宣言
		stage = new Stage(AICanvas);
		var ColorCanvas = document.getElementById("Color_Field"); //色描画キャンバスの宣言
		colx = ColorCanvas.getContext("2d");
		var EventCanvas = document.getElementById("Event_Field"); //イベント描画キャンバスの宣言
		evex = EventCanvas.getContext("2d");
		for(i=0;i<AI_num;i++){ AI[i] = new Shape(); stage.addChild(AI[i]); }
		Ticker.addEventListener("tick", function(){ stage.update(); });
		for(i=0;i<AI_num;i++){ //AIの初期座標の指定と描画とTweenの設定
			AI[i].x = 39.5+(26*AI_Log[0][i][0]); //x座標
			AI[i].y = 66+(26*AI_Log[0][i][1]); //y座標
			AI_Tween[i] = new Tween(AI[i], {loop:false}); //Tweenオブジェクトの作成
			drawAI(); //描画
			drawColorField(); //色の描画
		}
		alert("Hello");
		drawAnimation();
	}

	/* AIの描画関数(はじめの一回だけ) */
	function drawAI() {
		AI[i].graphics.beginStroke("black");
		AI[i].graphics.drawPolyStar(0, 0, 11, 5, 0.6, -90);
		stage.update();
	}

	/* マスの色の描画関数 */
	function drawColorField() {
		var cimg = new Image();
		cimg.src = "img/" + AI_col[i];
		var dx = AI[i].x-13.2;
		var dy = AI[i].y-13.2;
		cimg.onload = function() {
			colx.drawImage(cimg,dx,dy);
		}
	}

	/* アニメーション描画用関数 */
	function drawAnimation() {
		var timer = setInterval(function() {
			for (i = 0; i < AI_num; i++) {
				drawEvent();
				drawWalk();
				drawColorField();
				eventArise();
			}
			for (i = 0; i < AI_num; i++) {
				Battle();
			}
			turn++;
			if (turn == 33) {  //33ターン経ったら止まる(本当は500ターン)
				clearInterval(timer);
			}
		}, 200);
	}

	/* イベントマス描画関数(テスト用) */
	function drawEvent() {
		if (Event_Log[e][0] == turn) {
			evex.beginPath();
			var x = 39.5 + (26 * Event_Log[e][2]);
			var y = 66 + (26 * Event_Log[e][3]);
			evex.arc(x, y, 12, 0, Math.PI * 2, false);
			evex.fill();
			e++;
		}
	}

	/* AIの移動処理関数 */
	function drawWalk() {
		if (AI_Log[turn][i][2] == 1) { //上に移動するときの処理
			if (AI[i].y == 66) {
				AI_Tween[i].to({y : 66 + (26 * 19)}, 0, Ease.linear);
				AI[i].y = 66 + (26 * 19);
			} else {
				AI_Tween[i].to({y : AI[i].y - 26}, 0, Ease.linear);
				AI[i].y -= 26;
			}
		} else if (AI_Log[turn][i][2] == 2) { //右に移動するときの処理
			if (AI[i].x == 39.5 + (26 * 19)) {AI_Tween[i].to({x : 39.5}, 0, Ease.linear);
				AI[i].x = 39.5;
			} else {
				AI_Tween[i].to({x : AI[i].x + 26}, 0, Ease.linear);
				AI[i].x += 26;
			}
		} else if (AI_Log[turn][i][2] == 3) { //下に移動するときの処理
			if (AI[i].y == 66 + (26 * 19)) {AI_Tween[i].to({y : 66}, 0, Ease.linear);
				AI[i].y = 66;
			} else {
				AI_Tween[i].to({y : AI[i].y + 26}, 0, Ease.linear);
				AI[i].y += 26;
			}
		} else if (AI_Log[turn][i][2] == 4) { //左に移動するときの処理
			if (AI[i].x == 39.5) {
				AI_Tween[i].to({x : 39.5 + (26 * 19)}, 0, Ease.linear);
				AI[i].x = 39.5 + (26 * 19);
			} else {
				AI_Tween[i].to({x : AI[i].x - 26}, 0, Ease.linear);
				AI[i].x -= 26;
			}
		}
	}


	/* AIがイベントを踏んだ時の処理関数 */
	function eventArise() {
		if (AI_Log[turn][i][3] == 0) {
			//何もしない
		} else if (AI_Log[turn][i][3] == 1) { //地雷を踏んだ時の処理
			alert("地雷を踏みました");
			var x = AI[i].x-(26*3.5);
			var y = AI[i].y-(26*3.5);
			colx.clearRect(x, y, 182, 182)
		} else if (AI_Log[turn][i][3] == 2) { //ワープを踏んだ時の処理
			alert("ワープを踏みました");
			AI[i].x = 39.5+(26*AI_Log[turn][i][0]);
			AI[i].y = 66+(26*AI_Log[turn][i][1]);
		} else if (AI_Log[turn][i][3] == 3) { //無敵を踏んだ時の処理
			alert("無敵を踏みました");
		}
	}

	/* 戦闘描画関数*/
	function Battle(){

	}
</script>
</head>

<body onload="drawBackGround();initialize();">
	<script>
		var i=0,e=0; //カウント用
		var turn = 1; //ターン数カウント用
		var AI_Log; //AI情報配列
		var Event_Log; //マップイベント情報配列
		var Obst_Log; //障害物情報配列
		var stage; //EaselJSのStageオブジェクト
		var colx; //Color_Fieldのコンテキスト
		var evex; //Event_Fieldのコンテキスト
		var AI = new Array(8); //AIのオブジェクト
		var AI_col = new Array("red.png","blue.png","purple.png","green.png","yellow.png","pink.png","orange.png","black.png"); //AIの色を格納
		var AI_Tween = new Array(8); //AIのTweenオブジェクト
		var AI_num = 4; //AIの数を格納
	</script>

	<canvas id="BackGround" width="572" height="624"></canvas>
	<canvas id="Color_Field" width="572" height="624"></canvas>
	<canvas id="Event_Field" width="572" height="624"></canvas>
	<canvas id="AI_Field" width="572" height="624"></canvas>
</body>
</html>